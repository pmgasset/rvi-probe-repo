#!/bin/sh
set -e

log() { logger -t rvi-provision "$*" 2>/dev/null || echo "$*"; }

MARK_DIR="/etc/rvi-probe"; UHTTPD_MARK="$MARK_DIR/uhttpd_installed"; mkdir -p "$MARK_DIR"

add_uhttpd() {
  if ! uci -q show uhttpd | grep -q "config uhttpd 'rvi'"; then
    uci -q add uhttpd uhttpd >/dev/null
    IDX=$(uci -q show uhttpd | awk -F'[][]' '/^uhttpd\.\@uhttpd\[[0-9]+\]=uhttpd/{print $2}' | tail -n1)
    [ -n "$IDX" ] && {
      uci -q set uhttpd.@uhttpd[$IDX].listen_http='127.0.0.1:8081'
      uci -q set uhttpd.@uhttpd[$IDX].home='/www'
      uci -q add_list uhttpd.@uhttpd[$IDX].cgi_prefix='/cgi-bin'
      uci -q set uhttpd.@uhttpd[$IDX].script_timeout='60'
      uci -q set uhttpd.@uhttpd[$IDX].network_timeout='30'
      uci -q set uhttpd.@uhttpd[$IDX].tcp_keepalive='1'
      uci -q add_list uhttpd.@uhttpd[$IDX].alias='/json=/cgi-bin/json'
      uci -q commit uhttpd
      touch "$UHTTPD_MARK"
    }
  else
    uci -q add_list uhttpd.rvi.alias='/json=/cgi-bin/json' 2>/dev/null || true
    uci -q commit uhttpd
  fi
  /etc/init.d/uhttpd reload >/dev/null 2>&1 || true
}

provision_cloudflared() {
  if ! command -v cloudflared >/dev/null 2>&1; then
    opkg update >/dev/null 2>&1 || true
    opkg install cloudflared >/dev/null 2>&1 || true
  fi
  [ -x /usr/bin/cloudflared ] || { log "cloudflared not available"; return 0; }

  IFACE="$(uci get network.lan.ifname 2>/dev/null || echo eth0)"
  MAC="$(ip link show "$IFACE" 2>/dev/null | awk '/link\/ether/{print $2}' | tr -d ':' | tr 'A-Z' 'a-z')"
  case "$MAC" in ''|*[!0-9a-f]*) log "Invalid MAC from $IFACE"; return 0;; esac

  WORKER_URL="https://status-hunter.traveldata.workers.dev/provision"
  RES=$(uclient-fetch -qO- -H 'Content-Type: application/json' -X POST -d "{\"mac\":\"$MAC\"}" "$WORKER_URL" 2>/dev/null \
        || curl -fsS -H 'Content-Type: application/json' -d "{\"mac\":\"$MAC\"}" "$WORKER_URL" 2>/dev/null || true)
  TOKEN=$(printf '%s' "$RES" | sed -n 's/.*"token"[[:space:]]*:[[:space:]]*"\([^"]\+\)".*/\1/p' | head -n1)
  [ -z "$TOKEN" ] && TOKEN=$(echo "$RES" | jq -r '.token // empty' 2>/dev/null || true)
  if [ -n "$TOKEN" ]; then
    mkdir -p /etc/rvi; umask 077
    printf '%s' "$TOKEN" > /etc/rvi/cloudflared.token
    chmod 600 /etc/rvi/cloudflared.token
    /etc/init.d/cloudflared enable >/dev/null 2>&1 || true
    /etc/init.d/cloudflared restart >/dev/null 2>&1 || true
    log "Provisioned tunnel token"
  else
    log "Provisioning failed"
  fi
}

chmod 0755 /usr/bin/rvi-* /usr/lib/rvi-probe/agent.sh /usr/lib/rvi-probe/cell.sh /www/cgi-bin/supportlink /www/cgi-bin/json 2>/dev/null || true
/etc/init.d/rvi-probe enable >/dev/null 2>&1 || true
/etc/init.d/rvi-probe start  >/dev/null 2>&1 || true

add_uhttpd
provision_cloudflared

command -v rvi-cloudflared-check >/dev/null 2>&1 && rvi-cloudflared-check >/dev/null 2>&1 || true

if ! opkg files rvi-probe >/dev/null 2>&1; then
  VER="__VER__"
  BASE="https://r2.rvinternethelp.com/openwrt/23.05"
  URL="$BASE/install-rvi-probe-${VER}.sh"
  TMP="/tmp/install-rvi-probe.sh"
  uclient-fetch -qO "$TMP" "$URL" 2>/dev/null || curl -fsSL -o "$TMP" "$URL" || TMP=""
  if [ -s "$TMP" ]; then
    chmod +x "$TMP"; sh "$TMP" || true
  fi
fi

exit 0

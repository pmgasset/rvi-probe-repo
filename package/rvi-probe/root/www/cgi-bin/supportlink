#!/bin/sh
# SupportLink: status JSON + speedtest
# - FIX: robust QUERY_STRING parsing (first param too)
# - Cloudflare-only server via LibreSpeed-compatible CLI (auto-install on demand)
# - Ookla CLI fallback
# - Always returns helpful JSON (debug via &debug=1)

set -efu

# ---------- headers / helpers ----------
header() { printf 'Content-Type: application/json\r\nCache-Control: no-store\r\n\r\n'; }
json_escape() { printf '%s' "$1" | sed 's/\\/\\\\/g; s/"/\\"/g'; }
have() { command -v "$1" >/dev/null 2>&1; }

# URL decode (+ -> space, %XX)
urldecode() { local s="${1//+/ }"; printf '%b' "${s//%/\\x}"; }

# Robust query reader: works for the first param and subsequent ones
qs_get() {
  local key="$1" qs="&${QUERY_STRING:-}&"
  # extract value between &key= and next &
  local raw; raw="$(printf '%s' "$qs" | sed -n "s/.*[&]$key=\([^&]*\).*/\1/p" | head -n1)"
  [ -n "$raw" ] && urldecode "$raw" || printf ''
}

sha1hex() {
  if have sha1sum; then printf '%s' "$1" | sha1sum | awk '{print $1}'
  elif have openssl; then printf '%s' "$1" | openssl dgst -sha1 -r | awk '{print $1}'
  else
    awk -v s="$1" 'BEGIN{
      for(i=0;i<256;i++){x=i;for(k=0;k<8;k++) x=(and(x,1)?xor(0xEDB88320, rshift(x,1)):rshift(x,1));T[i]=x}
      c=compl(0);for(i=1;i<=length(s);i++){c=and(xor(c,ord(substr(s,i,1))),255);c=xor(T[c],rshift(c,8))}c=xor(c,compl(0));printf "%08x",and(c,0xffffffff)
    } function and(a,b){return a&b} function rshift(x,n){return int(x/2^n)}
      function ord(c){return index("\0\1\2\3\4\5\6\7\b\t\n\13\14\15\16\17\20\21\22\23\24\25\26\27\30\31 !\"#$%&'\''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",c)}
      function xor(a,b, i,r){r=0;for(i=0;i<32;i++){r+=and((and(a,1)^and(b,1)),2^i);a=rshift(a,1);b=rshift(b,1)};return r}
      function compl(x){return -1-x}'
  fi
}

emit_error() { # usage: emit_error "msg" [install] [debug]
  header
  printf '{'
  printf '"ok":false,"error":"%s"' "$(json_escape "$1")"
  [ -n "${2:-}" ] && printf ',"install":"%s"' "$(json_escape "$2")"
  [ -n "${3:-}" ] && printf ',"debug":"%s"'   "$(json_escape "$3")"
  printf '}\n'
}

# ---------- identity / status ----------
mac_addr=''
for IF in br-lan eth0 lan wan wlan0; do
  [ -e "/sys/class/net/$IF/address" ] && mac_addr="$(cat "/sys/class/net/$IF/address" 2>/dev/null || true)"
  [ -n "${mac_addr:-}" ] && break || true
done
[ -z "${mac_addr:-}" ] && mac_addr="$(ip link 2>/dev/null | awk '/link\/ether/{print $2; exit}')"
did="$(printf '%s' "${mac_addr:-unknown}" | tr -d ':' | tr 'A-Z' 'a-z')"
hostname="${did}.nomadconnect.app"

uptime="$(cut -d. -f1 /proc/uptime 2>/dev/null || echo 0)"
tstate="down"; pgrep -f cloudflared >/dev/null 2>&1 && tstate="active"

bucket="$(date +%s | awk '{print int($1/300)}')"
seed="${hostname}:${bucket}:supportlink"
hex="$(sha1hex "$seed" | cut -c1-8)"
code="$(printf '%d\n' "0x${hex:-0}" | awk '{printf "%06d", ($1 % 1000000)}')"

inet="unknown"
if have curl; then
  WORKER_URL="$(uci -q get rviprobe.config.worker_url || true)"; [ -z "${WORKER_URL:-}" ] && WORKER_URL="https://status-hunter.traveldata.workers.dev"
  curl -fsSL "${WORKER_URL%/}/ping" >/dev/null 2>&1 && inet="cell" || true
fi
[ "$inet" = "unknown" ] && ping -c1 -W1 1.1.1.1 >/dev/null 2>&1 && inet="cell" || inet="$inet"

# ---------- Cloudflare speed test (LibreSpeed-compatible CLI) ----------
CF_URL="https://speed.cloudflare.com"

try_install_librespeed() {
  INSTALL_HINT=''
  have opkg || return 1
  opkg update >/dev/null 2>&1 || true
  for PKG in librespeed-cli speedtest-go; do
    INSTALL_HINT="opkg install $PKG"
    opkg --force-overwrite install "$PKG" >/dev/null 2>&1 && return 0 || true
  done
  return 1
}

run_cmd_json() { # usage: run_cmd_json "command string"
  CMD="$1"; OUT="/tmp/st_out.$$"; ERR="/tmp/st_err.$$"
  sh -c "$CMD" 1>"$OUT" 2>"$ERR" || true
  if grep -q '{' "$OUT" 2>/dev/null; then cat "$OUT"; rm -f "$OUT" "$ERR"; return 0; fi
  DBG="$(cat "$ERR" 2>/dev/null || true)"; rm -f "$OUT" "$ERR"; printf '%s' "$DBG"; return 1
}

run_cf_librespeed() {
  TRIED=""
  if have librespeed-cli; then
    for F in "--server" "--url" "--host" ""; do
      [ -n "$F" ] && TRIED="$TRIED;librespeed-cli --json $F $CF_URL" || TRIED="$TRIED;librespeed-cli --json"
      RES="$(run_cmd_json "librespeed-cli --json $F $CF_URL")" && { ENGINE="librespeed-cli"; JSON="$RES"; return 0; }
    done
  fi
  if have speedtest-go; then
    for F in "--server" "--url" "--host" ""; do
      [ -n "$F" ] && TRIED="$TRIED;speedtest-go --json $F $CF_URL" || TRIED="$TRIED;speedtest-go --json"
      RES="$(run_cmd_json "speedtest-go --json $F $CF_URL")" && { ENGINE="speedtest-go"; JSON="$RES"; return 0; }
    done
  fi
  DEBUG_TRIED="$(printf '%s' "$TRIED" | sed 's/^;//')"
  return 1
}

normalize_ls_json() {
  ST="$1"
  ping="$(printf '%s' "$ST" | sed -n 's/.*"ping"[[:space:]]*:[[:space:]]*\([0-9][0-9.]*\).*/\1/p' | head -n1)"
  down_mbps="$(printf '%s' "$ST" | sed -n 's/.*"download"[[:space:]]*:[[:space:]]*\([0-9][0-9.]*\).*/\1/p' | head -n1)"
  up_mbps="$(printf '%s' "$ST" | sed -n 's/.*"upload"[[:space:]]*:[[:space:]]*\([0-9][0-9.]*\).*/\1/p' | head -n1)"
  dbytes="$(printf '%s' "$ST" | sed -n 's/.*"downloadBytes"[[:space:]]*:[[:space:]]*\([0-9][0-9]*\).*/\1/p' | head -n1)"
  delap="$(printf '%s' "$ST" | sed -n 's/.*"downloadElapsed"[[:space:]]*:[[:space:]]*\([0-9][0-9]*\).*/\1/p' | head -n1)"
  ubytes="$(printf '%s' "$ST" | sed -n 's/.*"uploadBytes"[[:space:]]*:[[:space:]]*\([0-9][0-9]*\).*/\1/p' | head -n1)"
  uelap="$(printf '%s' "$ST" | sed -n 's/.*"uploadElapsed"[[:space:]]*:[[:space:]]*\([0-9][0-9]*\).*/\1/p' | head -n1)"

  if [ -n "${down_mbps:-}" ]; then down_bps="$(awk -v M="$down_mbps" 'BEGIN{printf "%.0f", M*1000000}')"
  elif [ -n "${dbytes:-}" ] && [ -n "${delap:-}" ] && [ "$delap" -gt 0 ]; then down_bps="$(awk -v B="$dbytes" -v MS="$delap" 'BEGIN{printf "%.0f", (B*8)/(MS/1000.0)}')"; else down_bps=0; fi

  if [ -n "${up_mbps:-}" ]; then up_bps="$(awk -v M="$up_mbps" 'BEGIN{printf "%.0f", M*1000000}')"
  elif [ -n "${ubytes:-}" ] && [ -n "${uelap:-}" ] && [ "$uelap" -gt 0 ]; then up_bps="$(awk -v B="$ubytes" -v MS="$uelap" 'BEGIN{printf "%.0f", (B*8)/(MS/1000.0)}')"; else up_bps=0; fi

  [ -z "${ping:-}" ] && ping=0
  printf '{"ping":%s,"download":{"bandwidth":%s},"upload":{"bandwidth":%s}}' "$ping" "$down_bps" "$up_bps"
}

speedtest_cloudflare() {
  DEBUG="$(qs_get debug)"
  if run_cf_librespeed; then
    NORM="$(normalize_ls_json "$JSON")"
    header
    printf '{'
    printf '"ok":true,"engine":"%s","server":"%s",' "$(json_escape "$ENGINE")" "$(json_escape "$CF_URL")"
    printf '"speedtest":%s,' "$NORM"
    printf '"raw":%s' "$(printf '%s' "$JSON" | sed 's/\\/\\\\/g; s/"/\\"/g; s/.*/"&"/')"
    [ -n "$DEBUG" ] && printf ',"debug":"tried=%s"' "$(json_escape "${DEBUG_TRIED:-none}")"
    printf '}\n'
    return 0
  fi
  if try_install_librespeed && run_cf_librespeed; then
    NORM="$(normalize_ls_json "$JSON")"
    header; printf '{"ok":true,"engine":"%s","server":"%s","speedtest":%s,"raw":%s}\n' "$(json_escape "$ENGINE")" "$(json_escape "$CF_URL")" "$NORM" "$(printf '%s' "$JSON" | sed 's/\\/\\\\/g; s/"/\\"/g; s/.*/"&"/')"
    return 0
  fi
  emit_error "librespeed client not available or produced no JSON" "opkg update && opkg install librespeed-cli (or speedtest-go)" "${DEBUG_TRIED:-none}"
  return 1
}

speedtest_ookla() {
  if have speedtest; then
    OUT="/tmp/stdout_st.json"; ERR="/tmp/stderr_st.json"
    if speedtest --format=json --accept-license --accept-gdpr 1>"$OUT" 2>"$ERR"; then header; printf '{"ok":true,"engine":"ookla","speedtest":%s}\n' "$(cat "$OUT")"; rm -f "$OUT" "$ERR"; else emit_error "ookla speedtest failed" "" "$(cat "$ERR" 2>/dev/null || true)"; fi
  else
    emit_error "no speedtest engine available" "opkg update && wget -qO- https://install.speedtest.net/app/cli/install.sh | sh"
  fi
}

# ---------- routing ----------
action="$(qs_get action)"

if [ -n "$action" ]; then
  case "$action" in
    speedtest) speedtest_cloudflare || speedtest_ookla; exit 0 ;;
    restart_router)
      header
      pin="$(qs_get pin)"
      if [ -n "$pin" ] && [ "$pin" != "$code" ]; then printf '{"ok":false,"error":"bad pin"}\n'; else (sleep 1; /sbin/reboot) >/dev/null 2>&1 & printf '{"ok":true}\n'; fi
      exit 0 ;;
    *) emit_error "unknown action"; exit 0 ;;
  esac
fi

# ---------- default: status JSON ----------
header
printf '{'
printf '"internet":"%s","uptime":%s,' "$(json_escape "$inet")" "$uptime"
printf '"tunnel":{"state":"%s","hostname":"%s","id":"%s","code":"%s"}' \
  "$(json_escape "$tstate")" "$(json_escape "$hostname")" "$(json_escape "$did")" "$(json_escape "$code")"
printf '}\n'

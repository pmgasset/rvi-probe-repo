#!/bin/sh
# rvi-cloudflared-write-config: render a safe config.yml for cloudflared
set -eu
CFG_DIR="/etc/cloudflared"
CFG="$CFG_DIR/config.yml"
STATE_DIR="/etc/rvi"
HOST_FILE="$STATE_DIR/device_host"
MAC_IF="eth0"

mkdir -p "$CFG_DIR" "$STATE_DIR"

# Derive hostname
HOSTNAME=""
[ -s "$HOST_FILE" ] && HOSTNAME="$(cat "$HOST_FILE" 2>/dev/null || true)"
if [ -z "$HOSTNAME" ]; then
  MAC="$(cat /sys/class/net/$MAC_IF/address 2>/dev/null | tr -d ':\n' | tr 'A-Z' 'a-z' || true)"
  echo "$MAC" | grep -qE '^[0-9a-f]{12}$' || MAC="dev$(date +%s)"
  HOSTNAME="${MAC}.nomadconnect.app"
  printf '%s\n' "$HOSTNAME" > "$HOST_FILE"
fi

# If an existing config has a blank hostname in first rule, ignore it
if [ -s "$CFG" ]; then
  FIRST="$(awk '/ingress:/{flag=1;next} flag{print; exit}' "$CFG" 2>/dev/null || true)"
  case "$FIRST" in
    *'hostname: ""'*|*'hostname:""'*|*'hostname:'" "'*) rm -f "$CFG" ;;
  esac
fi

# Write config if missing or rewritten
if [ ! -s "$CFG" ]; then
  cat >"$CFG" <<EOF_CFG
# Auto-generated by rvi-probe
metrics: 127.0.0.1:2000
ingress:
  - hostname: ${HOSTNAME}
    service: http://127.0.0.1:8081
  - service: http_status:404
EOF_CFG
fi

echo "$CFG"

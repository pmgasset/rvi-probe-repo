#!/bin/sh
set -eu
CF_BIN=/usr/bin/cloudflared
TOKEN_FILE=/etc/cloudflared/token
INIT=/etc/init.d/cloudflared
WORKER_URL="https://status-hunter.traveldata.workers.dev/provision"

install_cloudflared() {
  if command -v opkg >/dev/null 2>&1; then
    opkg update >/dev/null 2>&1 && opkg install cloudflared >/dev/null 2>&1 || true
  fi
}

fetch_token() {
  IFACE="$(uci get network.lan.ifname 2>/dev/null || echo eth0)"
  MAC="$(ip link show "$IFACE" 2>/dev/null | awk '/link\/ether/{print $2}' | tr -d ':' | tr 'A-Z' 'a-z')"
  case "$MAC" in ''|*[!0-9a-f]*) echo "failed to determine MAC" >&2; return 1;; esac

  RES=$(uclient-fetch -qO- -H 'Content-Type: application/json' -X POST -d "{\"mac\":\"$MAC\"}" "$WORKER_URL" 2>/dev/null \
        || curl -fsS -H 'Content-Type: application/json' -d "{\"mac\":\"$MAC\"}" "$WORKER_URL" 2>/dev/null || true)
  TOKEN=$(printf '%s' "$RES" | sed -n 's/.*"token"[[:space:]]*:[[:space:]]*"\([^"]\+\)".*/\1/p' | head -n1)
  [ -z "$TOKEN" ] && TOKEN=$(echo "$RES" | jq -r '.token // empty' 2>/dev/null || true)
  if [ -n "$TOKEN" ]; then
    mkdir -p "$(dirname "$TOKEN_FILE")" 2>/dev/null; umask 077
    printf '%s' "$TOKEN" > "$TOKEN_FILE"
    chmod 0600 "$TOKEN_FILE" 2>/dev/null || true
    echo "token retrieved"
  else
    echo "failed to fetch token" >&2
    return 1
  fi
}

check_bin() {
  if [ -x "$CF_BIN" ]; then
    echo "cloudflared binary present: $CF_BIN"
  else
    echo "cloudflared binary missing: $CF_BIN"
    install_cloudflared
    [ -x "$CF_BIN" ] && echo "cloudflared binary installed" || echo "cloudflared install failed"
  fi
}

check_token() {
  if [ -s "$TOKEN_FILE" ]; then
    echo "token contents: $(cat "$TOKEN_FILE")"
  else
    echo "token file missing or empty: $TOKEN_FILE"
    fetch_token || echo "token fetch failed" >&2
    [ -s "$TOKEN_FILE" ] && echo "token file created: $(cat "$TOKEN_FILE")"
  fi
}

check_status() {
  if [ -x "$INIT" ]; then
    echo "cloudflared service status:"
    "$INIT" status || true
  else
    echo "init script missing: $INIT"
  fi
}

check_bin
check_token
check_status

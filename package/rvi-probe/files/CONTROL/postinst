#!/bin/sh
# postinst - rvi-probe
# Make everything non-fatal; log but never abort the install.
# opkg runs: postinst <version> configure
set +e

log() { echo "[rvi-probe postinst] $*"; }
have() { command -v "$1" >/dev/null 2>&1; }
exists() { [ -e "$1" ]; }

MARK_DIR="/etc/rvi-probe"
UHTTPD_MARK="$MARK_DIR/uhttpd_installed"
CF_MARK="$MARK_DIR/cloudflared_configured"
mkdir -p "$MARK_DIR" 2>/dev/null

safe_chmod() {
  for f in "$@"; do
    [ -e "$f" ] && chmod 0755 "$f" 2>/dev/null
  done
}

add_uhttpd() {
  if ! have uci; then
    log "uci not found; skipping uhttpd config"
    return 0
  fi

  # Ensure package config file exists
  [ -f /etc/config/uhttpd ] || touch /etc/config/uhttpd

  # Create or update a NAMED section 'rvi'
  if ! uci -q get uhttpd.rvi >/dev/null 2>&1; then
    uci -q batch <<'EOF'
set uhttpd.rvi=uhttpd
set uhttpd.rvi.listen_http='127.0.0.1:8081'
set uhttpd.rvi.home='/www'
add_list uhttpd.rvi.cgi_prefix='/cgi-bin'
set uhttpd.rvi.script_timeout='60'
set uhttpd.rvi.network_timeout='30'
set uhttpd.rvi.tcp_keepalive='1'
add_list uhttpd.rvi.alias='/json=/cgi-bin/json'
commit uhttpd
EOF
    touch "$UHTTPD_MARK"
    log "Created uhttpd.rvi listener on 127.0.0.1:8081"
  else
    # Ensure alias is present; be tolerant of duplicates
    uci -q add_list uhttpd.rvi.alias='/json=/cgi-bin/json' 2>/dev/null
    uci -q commit uhttpd
    log "Updated uhttpd.rvi alias list"
  fi

  if [ -x /etc/init.d/uhttpd ]; then
    /etc/init.d/uhttpd reload >/dev/null 2>&1 || /etc/init.d/uhttpd restart >/dev/null 2>&1 || true
  fi
}

setup_cloudflared() {
  # Optional integration only if init script exists
  [ -x /etc/init.d/cloudflared ] || { log "cloudflared not present; skipping"; return 0; }

  CFG=/etc/cloudflared/config.yml
  mkdir -p /etc/cloudflared 2>/dev/null

  if [ ! -s "$CFG" ] || ! grep -q "127.0.0.1:8081" "$CFG" 2>/dev/null; then
    cat > "$CFG" <<'YAML'
url: http://127.0.0.1:8081
metrics: 127.0.0.1:2000
ingress:
  - service: http://127.0.0.1:8081
  - service: http_status:404
YAML
    touch "$CF_MARK"
    log "Wrote /etc/cloudflared/config.yml"
  fi

  /etc/init.d/cloudflared enable >/dev/null 2>&1 || true
  /etc/init.d/cloudflared restart >/dev/null 2>&1 || true
}

# Fix modes IF files were unpacked
safe_chmod \
  /usr/bin/rvi-* \
  /usr/lib/rvi-probe/agent.sh \
  /usr/lib/rvi-probe/cell.sh \
  /www/cgi-bin/supportlink \
  /www/cgi-bin/json

# Enable/start our service if present
if [ -x /etc/init.d/rvi-probe ]; then
  /etc/init.d/rvi-probe enable >/dev/null 2>&1 || true
  /etc/init.d/rvi-probe start  >/dev/null 2>&1 || true
fi

add_uhttpd
setup_cloudflared

log "postinst complete"
exit 0

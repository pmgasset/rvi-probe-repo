#!/bin/sh
set -eu
CF_BIN=/usr/bin/cloudflared
TOKEN_FILE=/etc/cloudflared/token
INIT=/etc/init.d/cloudflared

install_cloudflared() {
  if command -v opkg >/dev/null 2>&1; then
    opkg update >/dev/null 2>&1 && opkg install cloudflared >/dev/null 2>&1 || true
  fi
}

ensure_token_file() {
  mkdir -p $(dirname "$TOKEN_FILE") 2>/dev/null
  if [ ! -f "$TOKEN_FILE" ]; then
    echo "TOKEN_PLACEHOLDER" > "$TOKEN_FILE"
    chmod 0600 "$TOKEN_FILE" 2>/dev/null || true
  fi
}

check_bin() {
  if [ -x "$CF_BIN" ]; then
    echo "cloudflared binary present: $CF_BIN"
  else
    echo "cloudflared binary missing: $CF_BIN"
    install_cloudflared
    [ -x "$CF_BIN" ] && echo "cloudflared binary installed" || echo "cloudflared install failed"
  fi
}

check_token() {
  if [ -s "$TOKEN_FILE" ]; then
    echo "token contents: $(cat "$TOKEN_FILE")"
  else
    echo "token file missing or empty: $TOKEN_FILE"
    ensure_token_file
    if [ -s "$TOKEN_FILE" ]; then
      echo "token file created: $(cat "$TOKEN_FILE")"
    fi
  fi
}

check_status() {
  if [ -x "$INIT" ]; then
    echo "cloudflared service status:"
    "$INIT" status || true
  else
    echo "init script missing: $INIT"
  fi
}

check_bin
check_token
check_status

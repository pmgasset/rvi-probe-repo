#!/bin/sh
# /www/cgi-bin/internet-details
# chmod +x /www/cgi-bin/internet-details

echo "Content-Type: application/json"
echo "Cache-Control: no-store"
echo ""

json_escape() {
    printf '%s' "$1" | sed \
        -e 's/\\\\/\\\\\\\\/g' \
        -e 's/"/\\"/g' \
        -e 's/\x08/\\b/g' \
        -e 's/\x0c/\\f/g' \
        -e 's/\n/\\n/g' \
        -e 's/\r/\\r/g' \
        -e 's/\t/\\t/g'
}

WORKER_URL="$(uci -q get rviprobe.config.worker_url 2>/dev/null)"
DATA=""
SOURCE=""

if [ -n "$WORKER_URL" ]; then
    DATA="$(curl -fs --connect-timeout 5 --max-time 5 "$WORKER_URL/internet-details" 2>/dev/null)"
    [ -n "$DATA" ] && SOURCE="multiple"
fi

if [ -z "$DATA" ]; then
    DATA="$(curl -fs --connect-timeout 5 --max-time 5 'http://ip-api.com/json/?fields=query,isp,org,as,country,regionName,city,proxy,hosting,mobile' 2>/dev/null)"
    SOURCE="ip-api"
fi

[ -n "$DATA" ] || { printf '{"status":"error","message":"lookup failed"}\n'; exit 0; }

IP=$(printf '%s' "$DATA" | awk -F'"query":"' '{print $2}' | awk -F'"' '{print $1}')
ISP=$(printf '%s' "$DATA" | awk -F'"isp":"' '{print $2}' | awk -F'"' '{print $1}')
ORG=$(printf '%s' "$DATA" | awk -F'"org":"' '{print $2}' | awk -F'"' '{print $1}')
ASN=$(printf '%s' "$DATA" | awk -F'"as":"' '{print $2}' | awk -F'"' '{print $1}')
COUNTRY=$(printf '%s' "$DATA" | awk -F'"country":"' '{print $2}' | awk -F'"' '{print $1}')
REGION=$(printf '%s' "$DATA" | awk -F'"regionName":"' '{print $2}' | awk -F'"' '{print $1}')
CITY=$(printf '%s' "$DATA" | awk -F'"city":"' '{print $2}' | awk -F'"' '{print $1}')

TYPE="unknown"
echo "$DATA" | grep -q '"mobile":true' && TYPE="mobile"
echo "$DATA" | grep -q '"proxy":true' && TYPE="proxy"
echo "$DATA" | grep -q '"hosting":true' && TYPE="hosting"

printf '{"ip":"%s","isp":"%s","org":"%s","type":"%s","asn":"%s","city":"%s","region":"%s","country":"%s","source":"%s","timestamp":%s}\n' \
    "$(json_escape "$IP")" \
    "$(json_escape "$ISP")" \
    "$(json_escape "$ORG")" \
    "$(json_escape "$TYPE")" \
    "$(json_escape "$ASN")" \
    "$(json_escape "$CITY")" \
    "$(json_escape "$REGION")" \
    "$(json_escape "$COUNTRY")" \
    "$(json_escape "$SOURCE")" \
    "$(date +%s)"

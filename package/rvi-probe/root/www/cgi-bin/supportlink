#!/bin/sh
# JSON status endpoint for SupportLink dashboard
printf "Content-Type: application/json\r\n\r\n"

PATH=/usr/sbin:/usr/bin:/sbin:/bin

log() {
    [ -n "$SUPPORTLINK_DEBUG" ] && logger -t supportlink "$*"
}

log "start pid=$$ time=$(date '+%Y-%m-%dT%H:%M:%S%z')"

json_escape() {
    printf '%s' "$1" | sed \
        -e 's/\\/\\\\/g' \
        -e 's/"/\\"/g' \
        -e 's/\x08/\\b/g' \
        -e 's/\x0c/\\f/g' \
        -e 's/\n/\\n/g' \
        -e 's/\r/\\r/g' \
        -e 's/\t/\\t/g'
}

# Find a stable MAC to use as device ID
pick_mac() {
    for IF in eth0 eth1 wan wwan0 wwan1 usb0 usb1; do
        [ -f "/sys/class/net/$IF/address" ] || continue
        MAC=$(cat "/sys/class/net/$IF/address" 2>/dev/null | tr -d ':\n' | tr 'A-Z' 'a-z')
        echo "$MAC" | grep -qE '^[0-9a-f]{12}$' && { echo "$MAC"; return 0; }
    done
    for IF in $(ls /sys/class/net 2>/dev/null | grep -v '^lo$'); do
        [ -f "/sys/class/net/$IF/address" ] || continue
        MAC=$(cat "/sys/class/net/$IF/address" 2>/dev/null | tr -d ':\n' | tr 'A-Z' 'a-z')
        echo "$MAC" | grep -qE '^[0-9a-f]{12}$' && { echo "$MAC"; return 0; }
    done
    return 1
}

HOST=$(hostname 2>/dev/null)
ID=$(cat /etc/rvi/cloudflared.tunnel_id 2>/dev/null)
[ -n "$ID" ] || ID=$(pick_mac 2>/dev/null || echo "")

TUN_HOST=$(cat /etc/rvi/device_host 2>/dev/null)
[ -n "$TUN_HOST" ] || TUN_HOST="$HOST"

# Determine tunnel state by checking for cloudflared
if pidof cloudflared >/dev/null 2>&1; then
    TUN_STATE="up"
    log "cloudflared running"
else
    TUN_STATE="down"
    log "cloudflared not running"
fi

# Default to offline then probe connectivity
INTERNET="offline"; STATUS="bad"; STATUS_TEXT="Offline"

# Try multiple 204 endpoints before falling back to IP probes
for URL in https://www.gstatic.com/generate_204 https://connectivitycheck.gstatic.com/generate_204; do
    log "probe $URL"
    if curl -fs --connect-timeout 5 --max-time 5 "$URL" >/dev/null 2>&1; then
        log "probe $URL exit 0"
        INTERNET="online"; STATUS="ok"; STATUS_TEXT="Online"
        break
    else
        RC=$?
        log "probe $URL exit $RC"
    fi
done

# If still not marked online, attempt direct IP probes (bypasses DNS)
if [ "$STATUS" != "ok" ]; then
    for IP in 1.1.1.1 9.9.9.9 8.8.8.8; do
        log "probe https://$IP"
        if curl -fs --connect-timeout 5 --max-time 5 --insecure "https://$IP" >/dev/null 2>&1; then
            log "probe https://$IP exit 0"
            INTERNET="DNS issue"; STATUS="warn"; STATUS_TEXT="DNS issue"
            break
        else
            RC=$?
            log "probe https://$IP exit $RC"
        fi
    done
fi

CODE=$( /usr/bin/rvi-sharecode 2>/dev/null || echo "" )

# Query ip-api.com only to populate ISP
log "ip-api lookup"
API=$(curl -fs --connect-timeout 5 --max-time 5 "http://ip-api.com/json?fields=isp" 2>/dev/null)
RC=$?
[ $RC -eq 0 ] || API=""
log "ip-api exit $RC"
ISP=$(printf '%s' "$API" |
    awk -F'"' '{for(i=1;i<NF;i++) if($i=="isp"){print $(i+2);break}}')
if [ -n "$API" ]; then
    INTERNET="online"
    STATUS="ok"
    STATUS_TEXT="Online"
    log "ip-api success; status set online"
else
    log "ip-api failed; status remains $STATUS"
fi

printf '{"host":"%s","tunnel_id":"%s","code":"%s","internet":"%s","isp":"%s","status":"%s","status_text":"%s","tunnel":{"hostname":"%s","id":"%s","state":"%s","code":"%s"}}\n' \
  "$(json_escape "$HOST")" \
  "$(json_escape "$ID")" \
  "$(json_escape "$CODE")" \
  "$(json_escape "$INTERNET")" \
  "$(json_escape "$ISP")" \
  "$(json_escape "$STATUS")" \
  "$(json_escape "$STATUS_TEXT")" \
  "$(json_escape "$TUN_HOST")" \
  "$(json_escape "$ID")" \
  "$(json_escape "$TUN_STATE")" \
  "$(json_escape "$CODE")"


<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SupportLink • Device Status</title>
<style>
  :root {
    --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa;
    --btn:#1f2937; --btnHover:#374151;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:960px;margin:40px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{font-size:28px;margin:0 0 8px}
  .sub{color:var(--muted);margin:0 0 14px}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:600}
  .ok{background:rgba(16,185,129,.14);color:#34d399;border:1px solid rgba(16,185,129,.35)}
  .warn{background:rgba(245,158,11,.14);color:#fbbf24;border:1px solid rgba(245,158,11,.35)}
  .bad{background:rgba(239,68,68,.14);color:#f87171;border:1px solid rgba(239,68,68,.35)}
  .muted{color:var(--muted)}
  .stat{padding:14px;border:1px dashed #374151;border-radius:12px}
  .k{display:block;color:var(--muted);font-size:12px}
  .v{font:600 18px/1.2 system-ui}
  .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
  button{appearance:none;border:1px solid #374151;background:var(--btn);color:#e5e7eb;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600}
  button:hover{background:var(--btnHover)}
  .accent{border-color:#1e40af}
  .danger{border-color:#7f1d1d}
  .wide{width:100%}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .small{font-size:12px}
  .hr{height:1px;background:#1f2937;margin:16px 0}
  .log{background:#0b1022;border:1px solid #1f2937;border-radius:12px;padding:12px;white-space:pre-wrap;max-height:300px;overflow:auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  /* Modal + chips */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;background:rgba(0,0,0,.45)}
  .modal.open{display:flex}
  .modal-content{background:var(--panel);border:1px solid #1f2937;border-radius:16px;max-width:900px;width:100%;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.4)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .close{cursor:pointer;font-weight:700;border:1px solid #374151;border-radius:8px;padding:4px 10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{font-size:13px;padding:8px 10px;border-radius:999px;border:2px solid #374151;background:#0e162d;color:#d1d5db;cursor:pointer}
  .chip[disabled]{opacity:.65;cursor:not-allowed}
  .result-card{border:1px solid #1f2937;border-radius:12px;padding:10px;background:#0b1022}
  .kgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .muted-link{color:#93c5fd;text-decoration:none}
  .muted-link:hover{text-decoration:underline}

  /* Chip status outlines */
  .chip.ok{ border-color:#10b981; color:#10b981; }
  .chip.warn{ border-color:#f59e0b; color:#f59e0b; }
  .chip.bad{ border-color:#ef4444; color:#ef4444; }
  .chip.unknown{ border-color:#6b7280; color:#9ca3af; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SupportLink</h1>
    <p class="sub">Fast help from RV Internet Help. Keep this page open if you’re on the phone with support.</p>

    <div class="grid" id="stats">
      <div class="stat"><span class="k">Hostname</span><span class="v mono" id="host">—</span></div>
      <div class="stat"><span class="k">Device ID</span><span class="v mono" id="did">—</span></div>
      <div class="stat"><span class="k">Share Code (tell support)</span><span class="v mono" id="code">—</span><span class="small muted">Changes every 5 minutes</span></div>
      <div class="stat"><span class="k">Internet</span><span class="v" id="inet">—</span></div>
    </div>

    <div class="row" style="margin-top:10px">
      <span id="statusPill" class="pill warn">Checking…</span>
      <span class="muted small">Last updated <span id="ago">—</span></span>
    </div>

    <div class="hr"></div>

    <div class="actions">
      <button class="accent" id="btnSpeed">Run Speed Test</button>
      <button id="btnInetDetails">Internet Details</button>
      <button class="danger" id="btnReboot">Restart My Router</button>
    </div>

    <div id="results" class="log" style="display:none;margin-top:12px"></div>
  </div>
</div>

<!-- Internet Details Modal -->
<div class="modal" id="inetModal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">Internet Details</h3>
      <button class="close" id="inetClose">Close</button>
    </div>

    <div id="inetBody" class="result-card">
      <div class="small muted">Loading network info…</div>
    </div>

    <h4 style="margin:14px 0 6px">Outage Signals</h4>
    <div class="chips" id="providerChips">
      <!-- Carriers/ISPs -->
      <button class="chip" data-provider="att">AT&amp;T</button>
      <button class="chip" data-provider="verizon">Verizon</button>
      <button class="chip" data-provider="tmobile">T-Mobile</button>
      <button class="chip" data-provider="xfinity">Xfinity</button>
      <button class="chip" data-provider="spectrum">Spectrum</button>
      <button class="chip" data-provider="cox">Cox</button>
      <button class="chip" data-provider="starlink">Starlink</button>
      <!-- Streaming (top 4 + YouTube) -->
      <button class="chip" data-provider="youtube">YouTube</button>
      <button class="chip" data-provider="netflix">Netflix</button>
      <button class="chip" data-provider="disneyplus">Disney+</button>
      <button class="chip" data-provider="hulu">Hulu</button>
      <!-- Work apps -->
      <button class="chip" data-provider="zoom">Zoom</button>
      <button class="chip" data-provider="slack">Slack</button>
      <button class="chip" data-provider="m365">Microsoft&nbsp;365</button>
      <button class="chip" data-provider="teams">Teams</button>
      <button class="chip" data-provider="github">GitHub</button>
      <button class="chip" data-provider="cloudflare">Cloudflare</button>
      <button class="chip" data-provider="openai">OpenAI</button>
    </div>

    <div id="outageResults" style="display:grid;gap:8px;margin-top:10px"></div>

    <details style="margin-top:12px">
      <summary>Privacy</summary>
      <small class="muted">We fetch only public IP/ASN and public status pages. No browsing content is inspected. DNS-based app detection remains off unless you opt in.</small>
    </details>
  </div>
</div>

<script>
// Basic SupportLink dashboard logic
const host = document.getElementById('host');
const did = document.getElementById('did');
const code = document.getElementById('code');
const inet = document.getElementById('inet');
const statusPill = document.getElementById('statusPill');
const ago = document.getElementById('ago');
const results = document.getElementById('results');
const inetModal = document.getElementById('inetModal');
const inetClose = document.getElementById('inetClose');
const inetBody = document.getElementById('inetBody');
const outageResults = document.getElementById('outageResults');

async function refresh() {
  try {
    const r = await fetch('/cgi-bin/supportlink');
    const j = await r.json();
    host.textContent = j.host || j.hostname || '—';
    did.textContent = j.device_id || j.did || '—';
    code.textContent = j.code || j.share_code || '—';
    inet.textContent = j.internet || j.status_text || '—';
    const st = j.status || 'warn';
    statusPill.className = 'pill ' + st;
    statusPill.textContent = j.status_text || st;
    ago.textContent = 'just now';
  } catch (e) {
    statusPill.className = 'pill bad';
    statusPill.textContent = 'Error';
  }
}

refresh();
setInterval(refresh, 30000);

document.getElementById('btnSpeed').onclick = async () => {
  results.style.display = 'block';
  results.textContent = 'Running speed test...';
  const r = await fetch('/cgi-bin/supportlink?action=speed');
  results.textContent = await r.text();
};

document.getElementById('btnReboot').onclick = async () => {
  results.style.display = 'block';
  results.textContent = 'Sending reboot...';
  await fetch('/cgi-bin/supportlink?action=reboot');
  results.textContent = 'Reboot requested.';
};

document.getElementById('btnInetDetails').onclick = async () => {
  inetModal.classList.add('open');
  inetBody.innerHTML = '<div class="small muted">Loading network info…</div>';
  const r = await fetch('/cgi-bin/internet_details');
  const d = await r.json();
  inetBody.innerHTML = '<pre class="mono small">' + JSON.stringify(d, null, 2) + '</pre>';
};

inetClose.onclick = () => inetModal.classList.remove('open');

document.querySelectorAll('#providerChips .chip').forEach(chip => {
  chip.addEventListener('click', async () => {
    const provider = chip.dataset.provider;
    chip.disabled = true;
    chip.classList.add('unknown');
    const r = await fetch('/cgi-bin/outage_check?provider=' + provider);
    const d = await r.json();
    chip.classList.remove('ok', 'warn', 'bad', 'unknown');
    chip.classList.add(d.status || 'unknown');
    const card = document.createElement('div');
    card.className = 'result-card';
    card.innerHTML = '<div class="kgrid"><div><span class="k">Provider</span><span class="v">' + provider + '</span></div><div><span class="k">Status</span><span class="v">' + (d.status || 'unknown') + '</span></div></div><div class="small mono">' + (d.message || '') + '</div>';
    outageResults.appendChild(card);
    chip.disabled = false;
  });
});
</script>
</body>
</html>

#!/bin/sh
set -eu
CFG_DIR="/etc/cloudflared"
CFG="$CFG_DIR/config.yml"
STATE_DIR="/etc/rvi"
HOST_FILE="$STATE_DIR/device_host"

mkdir -p "$CFG_DIR" "$STATE_DIR"

# Determine hostname (from provision; fallback to eth0 MAC if missing)
HOSTNAME=""
[ -s "$HOST_FILE" ] && HOSTNAME="$(cat "$HOST_FILE" 2>/dev/null || true)"
if [ -z "$HOSTNAME" ]; then
  MAC="$(cat /sys/class/net/eth0/address 2>/dev/null | tr -d ':\n' | tr 'A-Z' 'a-z' || true)"
  echo "$MAC" | grep -qE '^[0-9a-f]{12}$' || MAC="dev$(date +%s)"
  HOSTNAME="${MAC}.nomadconnect.app"
  printf '%s\n' "$HOSTNAME" > "$HOST_FILE"
fi

# If an existing config has a blank hostname in the first rule, discard it
if [ -s "$CFG" ]; then
  FIRST="$(awk '/ingress:/{flag=1;next} flag{print; exit}' "$CFG" 2>/dev/null || true)"
  case "$FIRST" in
    *'hostname: ""'*|*'hostname:""'*|*'hostname:'" "*) rm -f "$CFG" ;;
  esac
fi

# Origin service (default 127.0.0.1:8081; can be changed later)
ORIGIN="${ORIGIN_SERVICE:-http://127.0.0.1:8081}"

# Write config if missing
if [ ! -s "$CFG" ]; then
  cat >"$CFG" <<EOF_CFG
# Auto-generated by rvi-probe
metrics: 127.0.0.1:2000
ingress:
  - hostname: ${HOSTNAME}
    service: ${ORIGIN}
  - service: http_status:404
EOF_CFG
fi

echo "$CFG"

#!/bin/sh
# Fetch Cloudflare tunnel token from provisioning Worker
PATH=/usr/sbin:/usr/bin:/sbin:/bin
URL="https://rvi-provision.traveldata.workers.dev"
MAC="$(ip link 2>/dev/null | awk '/link\/ether/{print $2; exit}' | tr -d ':' | tr 'A-Z' 'a-z')"
case "$MAC" in ''|*[!0-9a-f]*) exit 0;; esac
for d in 0 1 2 4; do
  [ "$d" -gt 0 ] && sleep "$d"
  RES=$(curl -fsSL -m 8 -H 'Content-Type: application/json' -d "{\"mac\":\"$MAC\"}" "$URL" 2>/dev/null) && break
  RES=""
done
TOKEN=$(printf '%s' "$RES" | sed -n 's/.*"token"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
TID=$(printf '%s' "$RES" | sed -n 's/.*"tunnel_id"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
HOST=$(printf '%s' "$RES" | sed -n 's/.*"hostname"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
[ -n "$TOKEN" ] || exit 0
mkdir -p /etc/rvi
umask 077
printf '%s' "$TOKEN" > /etc/rvi/cloudflared.token
chmod 600 /etc/rvi/cloudflared.token
[ -n "$TID" ] && { printf '%s' "$TID" > /etc/rvi/cloudflared.tunnel_id; chmod 600 /etc/rvi/cloudflared.tunnel_id; }
[ -n "$HOST" ] && { printf '%s' "$HOST" > /etc/rvi/device_host; chmod 600 /etc/rvi/device_host; }
exit 0
